<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menu explorer</title>
    <link rel="stylesheet" href="../assets/css/plate.css" />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 2rem;
        background: #f3f4f7;
      }
      .menu-wrap {
        max-width: 1100px;
        margin: 0 auto;
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1.5rem;
      }
      .menu-list {
        max-height: 70vh;
        overflow: auto;
        display: grid;
        gap: 0.35rem;
      }
      .menu-button {
        border: 1px solid #e0e6ed;
        background: #f7f9fb;
        padding: 0.45rem 0.6rem;
        border-radius: 8px;
        text-align: left;
        cursor: pointer;
      }
      .panel {
        display: grid;
        gap: 1rem;
      }
      .panel pre {
        background: #f7f9fb;
        padding: 0.75rem;
        border-radius: 8px;
        overflow: auto;
      }
      .field-list {
        display: grid;
        gap: 0.25rem;
      }
    </style>
  <link rel="stylesheet" href="/assets/css/seo.css?v=20260108_1" />
  </head>
  <body>
    <div class="menu-wrap">
      <section>
        <h1>Menu</h1>
        <div id="menu-status"></div>
        <div id="menu-list" class="menu-list"></div>
      </section>
      <section class="panel">
        <div>
          <h2 id="current-title">Selecteer een menu item</h2>
          <div id="sample-items" class="hv-plate-items"></div>
        </div>
        <div>
          <h3>Field inspector</h3>
          <div id="field-inspector"></div>
        </div>
      </section>
    </div>

    <script src="../assets/js/plate-proxyv7.js"></script>
    <script>
      const proxyBase = "http://proxyv7.easycarparts.nl";
      const menuStatus = document.getElementById("menu-status");
      const menuList = document.getElementById("menu-list");
      const currentTitle = document.getElementById("current-title");
      const sampleItems = document.getElementById("sample-items");
      const fieldInspector = document.getElementById("field-inspector");

      const BRAND_KEYWORDS = ["supplier", "brand", "make", "manufacturer"];
      const GROUP_KEYWORDS = ["group", "partgroup", "articlegroup", "productgroup", "category", "ktg"];

      function joinUrl(base, path) {
        const trimmed = String(base || "").replace(/\/+$/, "");
        const suffix = path.startsWith("/") ? path : `/${path}`;
        return `${trimmed}${suffix}`;
      }

      async function fetchJson(url) {
        const res = await fetch(url, { cache: "no-store", mode: "cors" });
        if (!res.ok) throw new Error(`Request failed: ${res.status}`);
        return res.json();
      }

      function isNumeric(value) {
        return (
          typeof value === "number" ||
          (typeof value === "string" && value.trim() && /^[0-9]+$/.test(value.trim()))
        );
      }

      function collectFieldStats(obj, path, depth, stats) {
        if (!obj || typeof obj !== "object" || depth > 5) return;
        if (Array.isArray(obj)) {
          obj.forEach((item, index) =>
            collectFieldStats(item, `${path}[${index}]`, depth + 1, stats)
          );
          return;
        }
        Object.keys(obj).forEach((key) => {
          const value = obj[key];
          const nextPath = path ? `${path}.${key}` : key;
          if (value && typeof value === "object") {
            collectFieldStats(value, nextPath, depth + 1, stats);
            return;
          }
          if (isNumeric(value)) {
            const keyLower = key.toLowerCase();
            const pathLower = nextPath.toLowerCase();
            if (BRAND_KEYWORDS.some((kw) => keyLower.includes(kw) || pathLower.includes(kw))) {
              stats.brand[nextPath] = (stats.brand[nextPath] || 0) + 1;
            }
            if (GROUP_KEYWORDS.some((kw) => keyLower.includes(kw) || pathLower.includes(kw))) {
              stats.group[nextPath] = (stats.group[nextPath] || 0) + 1;
            }
          }
        });
      }

      function renderFieldInspector(stats) {
        const brandEntries = Object.entries(stats.brand || {}).sort((a, b) => b[1] - a[1]);
        const groupEntries = Object.entries(stats.group || {}).sort((a, b) => b[1] - a[1]);

        fieldInspector.innerHTML = "";
        const brandBlock = document.createElement("div");
        brandBlock.innerHTML =
          "<strong>Brand/supplier fields</strong>" +
          "<div class='field-list'>" +
          brandEntries.map(([key, count]) => `<div>${key} (${count})</div>`).join("") +
          "</div>";

        const groupBlock = document.createElement("div");
        groupBlock.innerHTML =
          "<strong>Product group fields</strong>" +
          "<div class='field-list'>" +
          groupEntries.map(([key, count]) => `<div>${key} (${count})</div>`).join("") +
          "</div>";

        fieldInspector.appendChild(brandBlock);
        fieldInspector.appendChild(groupBlock);
      }

      function renderSample(items) {
        sampleItems.innerHTML = "";
        if (!items.length) {
          sampleItems.textContent = "Geen items gevonden.";
          return;
        }
        items.slice(0, 10).forEach((raw) => {
          const item = HVPlate.normalizeItem(raw, {});
          const card = document.createElement("div");
          card.className = "hv-plate-card";
          const brandCode =
            item.brandCode !== null && item.brandCode !== undefined ? item.brandCode : "?";
          const groupCode =
            item.productGroupCode !== null && item.productGroupCode !== undefined
              ? item.productGroupCode
              : "?";
          card.innerHTML =
            `<div class="hv-plate-card__title">${item.title}</div>` +
            `<div class="hv-plate-card__meta">${item.supplierName || ""}</div>` +
            `<div class="hv-plate-debug">brand: ${brandCode} (${item.brandField || "-"}) | ` +
            `group: ${groupCode} (${item.groupField || "-"})</div>`;
          sampleItems.appendChild(card);
        });
      }

      async function loadMenu() {
        menuStatus.textContent = "Menu laden...";
        try {
          const data = await fetchJson(joinUrl(proxyBase, "/PartServices/api/Menu/"));
          const items = Array.isArray(data.MenuItems) ? data.MenuItems : [];
          menuStatus.textContent = `Menu items: ${items.length}`;
          menuList.innerHTML = "";
          items.forEach((item) => {
            const button = document.createElement("button");
            button.className = "menu-button";
            button.type = "button";
            button.textContent = `${item.MenuCode} - ${item.Menu}`;
            button.addEventListener("click", () => loadMenuParts(item.MenuCode, item.Menu));
            menuList.appendChild(button);
          });
        } catch (err) {
          menuStatus.textContent = "Fout bij laden menu.";
        }
      }

      async function loadMenuParts(menuCode, label) {
        currentTitle.textContent = `Menuparts: ${menuCode} - ${label}`;
        sampleItems.innerHTML = "Laden...";
        fieldInspector.innerHTML = "";
        try {
          const data = await fetchJson(
            joinUrl(proxyBase, `/PartServices/api/Menuparts/0/${menuCode}`)
          );
          const items = HVPlate.collectItemsFromMenuparts(data);
          renderSample(items);

          const stats = { brand: {}, group: {} };
          items.slice(0, 50).forEach((item) => collectFieldStats(item, "", 0, stats));
          renderFieldInspector(stats);
        } catch (err) {
          sampleItems.textContent = "Fout bij laden menuparts.";
        }
      }

      loadMenu();
    </script>
  </body>
</html>
